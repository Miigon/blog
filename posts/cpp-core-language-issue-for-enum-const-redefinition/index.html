<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="记一次 C++ 核心语言标准中一个 issue 的发现和提交经历" /><meta property="og:locale" content="en" /><meta name="description" content="该文章记录自己的一次发现一个 C++ 核心语言标准规定中，关于枚举量重定义的一个规则缺陷（defect）并提交的经历。所有对标准的引用以 N4901 草案为准（当时的较新版本）。" /><meta property="og:description" content="该文章记录自己的一次发现一个 C++ 核心语言标准规定中，关于枚举量重定义的一个规则缺陷（defect）并提交的经历。所有对标准的引用以 N4901 草案为准（当时的较新版本）。" /><link rel="canonical" href="https://blog.miigon.net/posts/cpp-core-language-issue-for-enum-const-redefinition/" /><meta property="og:url" content="https://blog.miigon.net/posts/cpp-core-language-issue-for-enum-const-redefinition/" /><meta property="og:site_name" content="Miigon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-02T22:10:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="记一次 C++ 核心语言标准中一个 issue 的发现和提交经历" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-25T17:57:21+08:00","datePublished":"2022-04-02T22:10:00+08:00","description":"该文章记录自己的一次发现一个 C++ 核心语言标准规定中，关于枚举量重定义的一个规则缺陷（defect）并提交的经历。所有对标准的引用以 N4901 草案为准（当时的较新版本）。","headline":"记一次 C++ 核心语言标准中一个 issue 的发现和提交经历","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.miigon.net/posts/cpp-core-language-issue-for-enum-const-redefinition/"},"url":"https://blog.miigon.net/posts/cpp-core-language-issue-for-enum-const-redefinition/"}</script><title>记一次 C++ 核心语言标准中一个 issue 的发现和提交经历 | Miigon's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Miigon's blog"><meta name="application-name" content="Miigon's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Miigon's blog</a></div><div class="site-subtitle font-italic">My ideas, thoughts and experiences</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Miigon" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['miigon.pg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://stackoverflow.com/users/7509248/miigon" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>记一次 C++ 核心语言标准中一个 issue 的发现和提交经历</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>记一次 C++ 核心语言标准中一个 issue 的发现和提交经历</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1648908600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 2, 2022 </em> </span> <span> Updated <em class="" data-ts="1658743041" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 25, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/Miigon">Miigon</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2344 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><blockquote><p>该文章记录自己的一次发现一个 C++ 核心语言标准规定中，关于枚举量重定义的一个规则缺陷（defect）并提交的经历。所有对标准的引用以 N4901 草案为准（当时的较新版本）。</p></blockquote><p><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4901.pdf">C++ 核心语言标准 N4901 草案</a></p><h1 id="引言">引言</h1><p>问题本身是关于 enum 中枚举值 (enumerator) 的重复定义问题的。</p><p>例子如下：</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">ee</span><span class="p">,</span> <span class="n">ee</span>
<span class="p">};</span>
</pre></table></code></div></div><p>上面的代码，无论是在 gcc/clang 还是 g++/clang++ 上，编译都是不能通过的，报错如下：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>enumtest.cpp:3:2: error: redefinition of enumerator 'A'
        A,
        ^
enumtest.cpp:2:2: note: previous definition is here
        A,
        ^
1 error generated.
</pre></table></code></div></div><p>也就是常用的两个编译器实现上，无论 C 还是 C++ 都不允许枚举值的重复定义（注意区分枚举类型和枚举值）。</p><p>C99 草案中对该行为作出了明确规定：</p><blockquote><p>From the draft of C99, Section 6.7:<br /> 6.7.5. A declaration specifies the interpretation and attributes of a set of identifiers. A definition of an identifier is a declaration for that identifier that:<br /> — for an object, causes storage to be reserved for that object;<br /> — for a function, includes the function body; <br /> — for an <strong>enumeration constant or typedef name, is the (only) declaration of the identifier.</strong></p></blockquote><p>enumeration constant 即枚举常量，也就是上述代码中的 <code class="language-plaintext highlighter-rouge">ee</code>。C 语言标准的这一规定，就避免了同一个标识符被多次用于定义枚举值。在实际的使用中这一行为也符合逻辑，因为每一个枚举值在未指定具体常数值的情况下，是递增分配整形常数值的，如果允许枚举值 enumerator 同名可能导致一个枚举值名字对应多个常数值，造成歧义。</p><h1 id="问题">问题</h1><p>按理来说，C++ 在大多数情况下都可以认为是 C 的超集，C 标准明确规定不能通过编译的代码，在 C++ 中应该也不能通过。由于枚举类型定义的时候，会顺带定义其中的所有枚举值，又因为定义是一种特殊的声明，那么 C++ 标准中就必然存在一定的规则，要么阻止枚举量的重复定义，要么阻止枚举量的重复声明，使得上述代码非法。</p><h2 id="one-definition-rule-不阻止枚举量的重复定义"><span class="mr-2">One-definition rule 不阻止枚举量的重复定义</span><a href="#one-definition-rule-不阻止枚举量的重复定义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>出于好奇，查找了一下 C++ 关于这方面的规定，了解到 C++ 中，有一个单独列出的 One-definition rule 条目（6.3 [basic.def.odr]），其中第一条规定如下：</p><blockquote><p>No translation unit shall contain more than one definition of any variable, function, class type, enumeration type, template, default argument for a parameter (for a function in a given scope), or default template argument.</p></blockquote><p>即：所有的翻译单元都不可以包含多于一个的任何变量、函数、类、<strong>枚举类型</strong>、模版、参数默认值或默认模版参数的定义。</p><p>这里特别注意到，<strong>One-definition rule 限制了「枚举类型」的重复定义，但是没有限制「枚举量」的重复定义。</strong></p><p>当然 One-definition rule 相当于是在原来的声明/定义规则上打的一个“补丁”，直接用特殊规则来限制一些种类实体的重复定义。并不代表标准中的其他规则就不会限制重复定义的枚举值的存在（这在后续与委员会的邮件交流中也涉及到了），所以这里没有限制并不足以作为允许枚举量重复定义的充分条件。</p><p>由于定义是一种特殊的声明，虽然定义 definition 相关的规则没能阻止例子中的代码通过编译，但是仍然有可能在声明 declaration 中阻止了这样重复声明枚举量的情况出现，故继续探寻，发现：</p><h2 id="declaration-声明规则允许枚举量重复声明"><span class="mr-2">declaration 声明规则允许枚举量重复声明</span><a href="#declaration-声明规则允许枚举量重复声明" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="两次-ee-声明的是同一实体"><span class="mr-2">两次 <code class="language-plaintext highlighter-rouge"><span class="mr-2">ee</code> 声明的是同一实体</span><a href="#两次-ee-声明的是同一实体" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>继续浏览标准中关于声明 declaration 和定义 definition 的章节，可以看到如下描述：</p><p>6.6 [basic.link] paragraph 8:</p><blockquote><p><strong>Two declarations</strong> of entities <strong>declare the same entity if</strong>, considering declarations of unnamed types to introduce their names for linkage purposes, if any (9.2.4, 9.7.1), they <strong>correspond</strong> (6.4.1), <strong>have the same target scope</strong> that is not a function or template parameter scope, and either</p><ul><li>they <strong>appear in the same translation unit</strong>, or……. （后续几种情况与问题无关，故没有列出）</ul></blockquote><p>即两个实体声明（在这里指两次枚举量定义 <code class="language-plaintext highlighter-rouge">ee</code> 和 <code class="language-plaintext highlighter-rouge">ee</code>，定义也是一种声明）如果它们满足：</p><ul><li>相互「对应」（例子满足）<li>在同一个作用域（例子满足）<li>且出现在同一个翻译单元（例子满足）</ul><p>则他们声明的是同一个实体。</p><p>「对应 correspond」的意思，在6.4.1 [basic.scope.scope], paragraph 4 中指出：</p><blockquote><p><strong>Two declarations correspond if they (re)introduce the same name</strong>, both declare constructors, or both declare destructors, unless……<br /> （后面的排除情况比较复杂，但都不适用本文中的例子，故省略）</p></blockquote><p>在这里，两个枚举量声明由于引入了同一个名字，所以说它们「对应」。</p><p>也就是说，他们满足了声明同一个实体的三个条件，<strong>两次 <code class="language-plaintext highlighter-rouge">ee</code> 声明的是同一实体</strong>。</p><blockquote><p>这个规则一般是服务于函数声明、变量声明或者类型声明的，即多次声明同一个函数，声明的其实都是同一个函数：</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// 例子：此代码是合法C++程序，能通过编译</span>
<span class="kt">void</span> <span class="nf">foobar</span><span class="p">();</span><span class="c1">// 声明</span>
<span class="kt">void</span> <span class="nf">foobar</span><span class="p">();</span><span class="c1">// 再次声明</span>
<span class="kt">void</span> <span class="nf">foobar</span><span class="p">()</span> <span class="p">{}</span> <span class="c1">// 再次声明，并定义，前面所有的声明都指向这里定义的实体</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">foobar</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>但是在这一套规则下，我们一开始例子中的枚举量定义 <code class="language-plaintext highlighter-rouge">ee</code> 和 <code class="language-plaintext highlighter-rouge">ee</code> 也恰好符合这里的要求，即两次指向同一个实体。</p></blockquote><p>两次 <code class="language-plaintext highlighter-rouge">ee</code> 声明的是同一实体为什么重要呢？因为声明还有一种「冲突」的情况如下：</p><h3 id="两次-ee-声明不满足可能冲突的条件不造成冲突"><span class="mr-2">两次 <code class="language-plaintext highlighter-rouge"><span class="mr-2">ee</code> 声明不满足「可能冲突」的条件，不造成冲突</span><a href="#两次-ee-声明不满足可能冲突的条件不造成冲突" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>6.4.1 [basic.scope.scope]:</p><blockquote><p><strong>Two declarations <em>potentially conflict</em> if they correspond and cause their shared name to denote different entities (6.6)</strong>. The program is ill-formed if, in any scope, a name is bound to two declarations that <em>potentially conflict</em> and one precedes the other (6.5).</p></blockquote><p>当两个声明「对应」（满足）并使得他们共有的名字<strong>指向两个不同实体时</strong>，两个声明即「可能冲突」。</p><p>而前面一段已经说明了，两次 <code class="language-plaintext highlighter-rouge">ee</code> 声明，指向的是<strong>同一实体</strong>，也就是说这里「可能冲突」的规则并不适用，两次声明不冲突。</p><h2 id="结论枚举量重复定义不违反-c-标准"><span class="mr-2">结论：枚举量重复定义不违反 C++ 标准！</span><a href="#结论枚举量重复定义不违反-c-标准" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>由于 One-definition rule 并不限制枚举量的重复定义，而两次枚举量声明指向的是同一个实体，不会造成声明冲突，意味着一开始的示例代码：</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">ee</span><span class="p">,</span> <span class="n">ee</span>
<span class="p">};</span>
</pre></table></code></div></div><p>其中重复的 <code class="language-plaintext highlighter-rouge">ee</code>，无论是从实体定义的角度，还是从实体声明的角度，都<strong>不违反 C++ 标准中的规则</strong>，也就是说当前 C++ 标准没有像 C 标准一样成功阻止该有歧义的程序通过编译。</p><h1 id="总结">总结</h1><p>当然，对同一个名字进行多次枚举量定义肯定在逻辑上是错误的，每个枚举量都必须对应「一个」整型常量，每一个枚举量定义又会使得枚举量对应的常量相比上一个枚举量定义增1，允许同个名字定义两次枚举量的话，这两个规则就产生矛盾了。（例如上面的例子里，ee 同时对应 0 和 1）</p><p>在这里，合理的解决方法应该是将枚举值 (enumerator、enumeration constant) 加入到 One-definition rule 中，阻止枚举值的重复定义。</p><p>我也将相关的信息提交给了 C++ 标准委员会相关人员，并经过几轮邮件来回解释，该问题已经被接受并成为 <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/cwg_active.html#2530">C++ 核心语言议题 #2530</a>。应该会在下一次委员会会议中讨论并可能在未来草案中修复。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>That's a good point that I had overlooked; it seemed clear that 
two enumerators (that, in general, have different values) cannot 
declare the same entity, which in the case of an enumerator, is 
only a value. However, this wording contradicts that reasoning, 
so you've convinced me. This will be issue 2530 in revision 108 
of the core language issues list.
                                      -- William M. (Mike) Miller
</pre></table></code></div></div><p>最奇妙的是，这个疏忽虽然看起来很微不足道，但它至少从 <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2005/n1905.pdf">C++03</a> 之前就存在了（C++03 标准文档有版权问题，这里链接是2005年的工作稿），一直存在了20来年，期间的编译器作者也都默认按照 C 的规则去处理了，也没有人提交过相关 defect。甚至有理由怀疑是 C++ 标准里存在时间最久的 bug 之一，果然最简单的问题藏在眼皮底下反而不容易被发现 😃 。</p><blockquote><p>我的博客即将同步至腾讯云开发者社区，邀请大家一同入驻：https://cloud.tencent.com/developer/support-plan?invite_code=h98n0pl8nhui</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/language/'>Language</a>, <a href='/categories/c/'>C++</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/c-standard/" class="post-tag no-text-decoration" >c++ standard</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E8%AE%B0%E4%B8%80%E6%AC%A1+C%2B%2B+%E6%A0%B8%E5%BF%83%E8%AF%AD%E8%A8%80%E6%A0%87%E5%87%86%E4%B8%AD%E4%B8%80%E4%B8%AA+issue+%E7%9A%84%E5%8F%91%E7%8E%B0%E5%92%8C%E6%8F%90%E4%BA%A4%E7%BB%8F%E5%8E%86+-+Miigon%27s+blog&url=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fcpp-core-language-issue-for-enum-const-redefinition%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E8%AE%B0%E4%B8%80%E6%AC%A1+C%2B%2B+%E6%A0%B8%E5%BF%83%E8%AF%AD%E8%A8%80%E6%A0%87%E5%87%86%E4%B8%AD%E4%B8%80%E4%B8%AA+issue+%E7%9A%84%E5%8F%91%E7%8E%B0%E5%92%8C%E6%8F%90%E4%BA%A4%E7%BB%8F%E5%8E%86+-+Miigon%27s+blog&u=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fcpp-core-language-issue-for-enum-const-redefinition%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fcpp-core-language-issue-for-enum-const-redefinition%2F&text=%E8%AE%B0%E4%B8%80%E6%AC%A1+C%2B%2B+%E6%A0%B8%E5%BF%83%E8%AF%AD%E8%A8%80%E6%A0%87%E5%87%86%E4%B8%AD%E4%B8%80%E4%B8%AA+issue+%E7%9A%84%E5%8F%91%E7%8E%B0%E5%92%8C%E6%8F%90%E4%BA%A4%E7%BB%8F%E5%8E%86+-+Miigon%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/storing-hash-objects-on-filesystem/">[随笔]文件系统上存储哈希对象：哈希算法以及目录结构对性能的影响</a><li><a href="/posts/origin-of-git-feat-bitkeeper/">git的前世，和BitKeeper</a><li><a href="/posts/golang-loop-var-reference-problems-and-semantic-fix/">随笔：Golang 循环变量引用问题以及官方语义修复</a><li><a href="/posts/s081-lab6-copy-on-write-fork/">[mit6.s081] 笔记 Lab6: Copy-on-write fork | fork 懒拷贝</a><li><a href="/posts/mysql-prepare-slower-query-bug-analyze/">MySQL Prepare后语句查询性能降低 内核源码bug排查分析</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-system/">operating system</a> <a class="post-tag" href="/tags/chinese/">Chinese</a> <a class="post-tag" href="/tags/system-design/">system design</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/course-recommendation/">course recommendation</a> <a class="post-tag" href="/tags/grpc/">gRPC</a> <a class="post-tag" href="/tags/translated/">translated</a> <a class="post-tag" href="/tags/announcement/">announcement</a> <a class="post-tag" href="/tags/c-standard/">c++ standard</a> <a class="post-tag" href="/tags/computer-system/">computer system</a></div></div><div id="access-links" class="post"><div class="panel-heading">Links</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="http://0xffff.one">0xffff.one 搬砖技术社区</a><li><a href="https://blog.izgq.net">ZGQ's Blog</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/golang-loop-var-reference-problems-and-semantic-fix/"><div class="card-body"> <em class="small" data-ts="1678871100" data-df="ll" > Mar 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>随笔：Golang 循环变量引用问题以及官方语义修复</h3><div class="text-muted small"><p> 这篇文章谈一个已经在 Golang 中存在多年的，几乎每一个新手都要被坑一遍的设计：引用捕获了循环变量，且逃逸出循环迭代范围而造成的逻辑错误。 以及重点是讨论了目前对这个常见问题的解决办法的探索（静态分析存在的不足，以及2022年10月 Golang 官方提出的直接更改 for 循环变量语义，从语言设计上根本地消除这个问题的 proposal） background 这个问题是一个 Go...</p></div></div></a></div><div class="card"> <a href="/posts/storing-hash-objects-on-filesystem/"><div class="card-body"> <em class="small" data-ts="1672391760" data-df="ll" > Dec 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[随笔]文件系统上存储哈希对象：哈希算法以及目录结构对性能的影响</h3><div class="text-muted small"><p> 从文件系统的实现原理角度讨论 /77/e1/77e1cccccc... 模式的 hash object 命名的优点以及必要/不必要性，以及算法选择。 原贴 这是我在 0xffff 论坛的回帖的备档：https://0xffff.one/d/1395-wen-jian-xi-tong-zuo-wei-huan-cun 一个常见的业务场景，需要实现一个 Key-Value Cach...</p></div></div></a></div><div class="card"> <a href="/posts/does-linux-has-zombie-thread/"><div class="card-body"> <em class="small" data-ts="1669196820" data-df="ll" > Nov 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux 是否有 zombie thread？从glibc和内核源码探究</h3><div class="text-muted small"><p> 系统编程课上遇到的一个问题：Linux下，如果一个 pthread_create 创建的线程没有被 pthread_join 回收，是否会和僵尸进程一样，产生“僵尸线程”，并一直占用一个 pid/tid？ 猜想 僵尸进程 对于进程与子进程来说，如果子进程退出了，但是父进程不对子进程进行 reap （即使用 wait/waitpid 对子进程进行回收），则子进程的 PCB（内核中的 ta...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/postgresql-source-compilation-guide/" class="btn btn-outline-primary" prompt="Older"><p>[SZU] 数据库内核课程 PostgreSQL 12.5 源码安装避坑 guide</p></a> <a href="/posts/origin-of-git-feat-bitkeeper/" class="btn btn-outline-primary" prompt="Newer"><p>git的前世，和BitKeeper</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "Miigon/blog", "data-repo-id": "MDEwOlJlcG9zaXRvcnkzMjI1MjkwNzA=", "data-category": "BlogComments", "data-category-id": "DIC_kwDOEzlnLs4CQ6Y4", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").prepend(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Miigon">Miigon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Customized Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-system/">operating system</a> <a class="post-tag" href="/tags/chinese/">Chinese</a> <a class="post-tag" href="/tags/system-design/">system design</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/course-recommendation/">course recommendation</a> <a class="post-tag" href="/tags/grpc/">gRPC</a> <a class="post-tag" href="/tags/translated/">translated</a> <a class="post-tag" href="/tags/announcement/">announcement</a> <a class="post-tag" href="/tags/c-standard/">c++ standard</a> <a class="post-tag" href="/tags/computer-system/">computer system</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
