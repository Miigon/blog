<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="随笔：Golang 循环变量引用问题以及官方语义修复" /><meta property="og:locale" content="en" /><meta name="description" content="这篇文章谈一个已经在 Golang 中存在多年的，几乎每一个新手都要被坑一遍的设计：引用捕获了循环变量，且逃逸出循环迭代范围而造成的逻辑错误。" /><meta property="og:description" content="这篇文章谈一个已经在 Golang 中存在多年的，几乎每一个新手都要被坑一遍的设计：引用捕获了循环变量，且逃逸出循环迭代范围而造成的逻辑错误。" /><link rel="canonical" href="https://blog.miigon.net/posts/golang-loop-var-reference-problems-and-semantic-fix/" /><meta property="og:url" content="https://blog.miigon.net/posts/golang-loop-var-reference-problems-and-semantic-fix/" /><meta property="og:site_name" content="Miigon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-15T17:05:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="随笔：Golang 循环变量引用问题以及官方语义修复" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-15T17:20:56+08:00","datePublished":"2023-03-15T17:05:00+08:00","description":"这篇文章谈一个已经在 Golang 中存在多年的，几乎每一个新手都要被坑一遍的设计：引用捕获了循环变量，且逃逸出循环迭代范围而造成的逻辑错误。","headline":"随笔：Golang 循环变量引用问题以及官方语义修复","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.miigon.net/posts/golang-loop-var-reference-problems-and-semantic-fix/"},"url":"https://blog.miigon.net/posts/golang-loop-var-reference-problems-and-semantic-fix/"}</script><title>随笔：Golang 循环变量引用问题以及官方语义修复 | Miigon's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Miigon's blog"><meta name="application-name" content="Miigon's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Miigon's blog</a></div><div class="site-subtitle font-italic">My ideas, thoughts and experiences</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Miigon" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['miigon.pg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://stackoverflow.com/users/7509248/miigon" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>随笔：Golang 循环变量引用问题以及官方语义修复</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>随笔：Golang 循环变量引用问题以及官方语义修复</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678871100" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 15, 2023 </em> </span> <span> Updated <em class="" data-ts="1678872056" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 15, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/Miigon">Miigon</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3223 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p>这篇文章谈一个已经在 Golang 中存在多年的，几乎每一个新手都要被坑一遍的设计：引用捕获了循环变量，且逃逸出循环迭代范围而造成的逻辑错误。</p><p>以及重点是讨论了目前对这个常见问题的解决办法的探索（静态分析存在的不足，以及2022年10月 Golang 官方提出的直接更改 for 循环变量语义，从语言设计上根本地消除这个问题的 proposal）</p><h1 id="background">background</h1><p>这个问题是一个 Golang 从很早版本就一直存在的设计选择造成的。</p><p>简单地讲就是 for 循环中，由于 func 捕获，或者显式/隐式的取引用，对循环变量产生了引用并且这个引用逃逸出了当前循环迭代（iteration）的生命周期范围。而由于 Golang 一开始决定将将循环变量（i、k、v）的生命周期定义为整个循环，而不是每个迭代都有新一份的循环变量，导致了每一轮迭代产生的引用实际上都指向同一个值，而不是指向每一轮各自对应的值。</p><p>常见的场景有以下：</p><ul><li>function literal captures loop variable</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">arr</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">}</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">}()</span> <span class="c">// v is a implicit reference</span>
<span class="p">}</span>
<span class="c">// prints 5 5 5 5 5</span>
</pre></table></code></div></div><ul><li>implicit reference due to receiver mismatch（更难发现）</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">MyInt</span> <span class="kt">int</span>

<span class="k">func</span> <span class="p">(</span><span class="n">mi</span> <span class="o">*</span><span class="n">MyInt</span><span class="p">)</span> <span class="n">Show</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">*</span><span class="n">mi</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">ms</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">MyInt</span><span class="p">{</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">}</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ms</span> <span class="p">{</span>
		<span class="k">go</span> <span class="n">m</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
		<span class="c">// implicitly converted to `go (&amp;m).Show()`</span>
		<span class="c">// thus creating a reference to loop variable.</span>
		<span class="c">// but you would never know this without more context.</span>
	<span class="p">}</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">100</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
<span class="p">}</span>
<span class="c">// prints 5 5 5 5 5</span>
</pre></table></code></div></div><ul><li>appending <code class="language-plaintext highlighter-rouge">&amp;v</code> to a slice</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">arr</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">}</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
	<span class="n">arr2</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="c">// all new elements &amp;v are the same.</span>
<span class="p">}</span>

<span class="c">// arr2 == {v_arr, v_arr, v_arr, v_arr, v_arr}</span>
<span class="c">// *v_arr == 5</span>
</pre></table></code></div></div><p>golang 的循环变量是 per loop 的，而不是 per iteration 的。如果对循环变量产生了引用（比如闭包 capture，或者取指针），不同次迭代取到的指针都是同一个。</p><p>如果这个指针/引用被逃逸出了一次迭代的范围内（比如 append 到了一个数组里，或者被go/defer后面的闭包capture了），因为所有 iteration 里取到的指针都是同一个，指向的对象也都会是同一个（最后一轮iteration的结果）。</p><h1 id="workaround">workaround</h1><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">alarms</span> <span class="p">{</span>
<span class="o">+</span>		<span class="n">a</span> <span class="o">:=</span> <span class="n">a</span>
 		<span class="k">go</span> <span class="n">a</span><span class="o">.</span><span class="n">Monitor</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
 	<span class="p">}</span>
</pre></table></code></div></div><p>一个 workaround 是加一句创建同名新变量 shadow 掉原来的循环变量，强制拷贝变量，把 per loop 的循环变量变成 per iteration的。</p><p>问题是很多时候很难知道某个循环是否需要写这么一行拷贝，导致很容易因为遗漏而产生bug。另一个极端是有的开发者因为担心遗漏，选择过度矫正，把所有的循环都写上这一句拷贝，使得代码可读性降低。</p><h1 id="vet-static-analysis">vet? static analysis?</h1><p>go vet 或其他 static analysis 方案虽然能帮助找到很明显的错误场景，但是由于静态分析并不能完全100%理解程序逻辑，在没有 proof 某个循环变量指针一定会超出 iteration 范围的前提下，会出现 false positive。</p><blockquote><p>并不能单用逃逸分析，根据引用是否逃逸来判定是否会出问题。</p><p>例子：循环体和 goroutine 之间可能使用了 waitgroup 进行了同步，从而使得虽然循环变量引用逃逸到了 goroutine 中，但是每一个 goroutine 的执行时机实际上都不会超过对应 iteration 的生命周期</p></blockquote><p>而 go vet 中的 loopclosure 则是采取了保守的方案，只有十足把握是错误情况才报告，会有false negative。</p><p>静态分析的问题是分析无法透过一些运行时功能，比如 interface 方法，比如 reflection。只能理解相对简单的代码。</p><h1 id="sematics-fix">sematics fix</h1><p>问题的本质是 golang 设计之初，决定将循环变量设定为 per loop 的而不是 per iteration 的。想要根除这个问题，需要在语义层面修复。即将循环变量设定为 per iteration。</p><p>Russ Cox（rsc）在2022年10月的时候，重新提出了这个话题： <a href="https://github.com/golang/go/discussions/56010">https://github.com/golang/go/discussions/56010</a></p><blockquote><h3 id="a-decade-of-experience-shows-the-cost-of-the-current-semantics"><span class="mr-2">A decade of experience shows the cost of the current semantics</span><a href="#a-decade-of-experience-shows-the-cost-of-the-current-semantics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>…… Since then, I suspect every Go programmer in the world has made this mistake in one program or another. I certainly have done it repeatedly over the past decade, despite being the one who argued for the current semantics and then implemented them. (Sorry!) The current cures for this problem are worse than the disease.</p></blockquote><p>rsc 提到了，在Golang进入Go1版本之前就已经讨论过这个问题，当时的结论是：虽然很烦但是问题没有大到要改。但是过去这个 decade 已经展示出来当前语义设计的后果。rsc 本人也常常被这个问题坑到。</p><p>更重要的是，目前对这个问题的解决方法，比问题本身还糟糕。</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">informer</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">c</span><span class="o">.</span><span class="n">informerMap</span> <span class="p">{</span>
<span class="o">+</span>		<span class="n">informer</span> <span class="o">:=</span> <span class="n">informer</span>
 		<span class="k">go</span> <span class="n">informer</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span>
 	<span class="p">}</span>
</pre></table></code></div></div><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">alarms</span> <span class="p">{</span>
<span class="o">+</span>		<span class="n">a</span> <span class="o">:=</span> <span class="n">a</span>
 		<span class="k">go</span> <span class="n">a</span><span class="o">.</span><span class="n">Monitor</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
 	<span class="p">}</span>
</pre></table></code></div></div><p>光看这两份代码，都有上述提到的 workaround。但实际上一个是真正的 bugfix，另一个是没有作用的。在没有上下文的前提下，没有任何办法区分。实际上其中一个是 interface 类型，创建拷贝变量并没有任何效果。另一个则是 struct 类型调用了 pointer receiver 方法，是真正的 bugfix。</p><p>并且，还有一些代码，不论上下文是什么，添加的拷贝都是没必要的拷贝（没有任何隐式引用循环变量的可能）：</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> 	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">scheme</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">artifact</span><span class="o">.</span><span class="n">Schemes</span> <span class="p">{</span>
<span class="o">+</span>		<span class="n">scheme</span> <span class="o">:=</span> <span class="n">scheme</span>
 		<span class="n">Runtime</span><span class="o">.</span><span class="n">artifactByScheme</span><span class="p">[</span><span class="n">scheme</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span>
 		<span class="n">Runtime</span><span class="o">.</span><span class="n">schemesByID</span><span class="p">[</span><span class="n">scheme</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">scheme</span>
 	<span class="p">}</span>
</pre></table></code></div></div><p>像这样的迷惑性和二义性，恰恰违反了 Go 可读的设计目标。</p><blockquote><p>This kind of confusion and ambiguity is the exact opposite of the readability we are aiming for in Go.</p></blockquote><p>之前 Golang 社区尝试通过文档和工具的方式，尝试防止用户因为这个语义而写出 bug 代码。但是实际实践中已经证明了，这种方式并不是非常有效，即使是语言的老手也经常不经意写出问题代码。</p><h2 id="the-official-fix"><span class="mr-2">the official fix</span><a href="#the-official-fix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在 <a href="https://github.com/golang/go/discussions/56010">https://github.com/golang/go/discussions/56010</a> 中提到的，从根本上彻底解决这个问题的方案是，将循环变量（三段式循环以及range循环）改为 per iteration。概念上等同于，在每个 iteration 开始时，将原本 per loop 的循环变量拷贝一份，并且在每个 iteration 结束时拷贝回去。</p><p>这样，每一轮 iteration 取到的地址都会是不同的地址。</p><p>而这个 sematic change 会通过 go.mod 来判断是否启用，旧的项目的行为照旧完全不变。</p><h2 id="effects-of-migrating-to-new-semantics"><span class="mr-2">effects of migrating to new semantics</span><a href="#effects-of-migrating-to-new-semantics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="googles-go-tests"><span class="mr-2">Google’s Go Tests</span><a href="#googles-go-tests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>目前（2023-03）这个提案还没有被正式确定引入 Golang 中。这里提到的结果都是 Golang 团队测试/实验的结果。</p></blockquote><blockquote><p>原文：Changing the semantics is usually a no-op, and when it’s not, it fixes buggy code far more often than it breaks correct code</p></blockquote><p>大多数情况下，这个语义变更没有影响。在有影响的情况下，常常产生的影响都是修复了有bug的代码，而不是让更多代码出问题。</p><p>他们（rsc）测试了 Google 内所有 Go 测试的一个子集。在变更语义后的新失败率大约是1/2000，但是几乎所有失败的测试都是之前没有发现的真实的bug。而原本正确的代码被这个更改影响坏的比率是1/50000。</p><p>10w 个测试（包含 130w 个 for loop） 中，只有 58 个测试出现了失败。其中 36 个（62%）测试是由于和 t.Parallel 错误的交互而导致的不正确的无效测试，而在 for 循环变量语义更改后反而更正了这些测试了（指的是：测试失败的原因，是原本错误的测试在语义更改后变得正确了，然后测试从无效变成了有效，并且帮助找到了代码里确实存在的 bug，所以报告了失败）。</p><p>第二大常见的错误是每一轮迭代将 &amp;v append 给了一个 slice，从而产生一个有 N 个相同指针的 slice。</p><p>在这 10w 个测试的 58 个失败的测试中，只找到了 2 个是真的依赖了 per-loop 循环变量的语义，并且真的因为语义变更而导致失败的：</p><blockquote><p>One involved a handler registered using once.Do that needed access to the current iteration’s values on each invocation. The other involved low-level code running in a context when allocation is disallowed, and the variable escaped the loop (but not the function), so that the old semantics did not allocate while the new semantics did.</p></blockquote><p>两个都非常地容易修复。</p><h3 id="perspective-csharps-migration-to-per-iteration-loop-vars"><span class="mr-2">perspective: csharp’s migration to per-iteration loop vars</span><a href="#perspective-csharps-migration-to-per-iteration-loop-vars" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>C# 团队中的 <a href="https://github.com/jaredpar">@jaredpar</a> （负责处理 customer feedback 的主要人物）提供了视角：</p><p>C#5 的时候也做过类似的更改，将 foreach 的循环变量从 per-loop 改为 per-iteration。当时由于 C# 没有类似 go.mod 的版本指定机制，所以唯一的选项就是要么无条件地改掉并且 break 一些东西，要么永远忍受现状。</p><p>循环变量的生命周期问题，在语言引入 lambda 表达式之后变成了一个痛点（闭包捕获）。随着语言对 lambda 表达式的使用越来越广泛，问题也越来越明显。严重到 C# 团队决定，无差别地全盘修改是值得的。相比给每个新的用户都解释一遍这个非常 tricky 的行为，相比之下给（但愿）数量较少的受影响的客户解释显得更容易一些。</p><p>最终的结果是：受这个更改所影响的客户的数量，比想象中的少。并且对于那些被影响到的客户，相应都是积极的，并且都接受了所提议的代码修复。</p><p>C# 作出这个更改已经10年了，jaredpar 的原话：”I’m honestly struggling to remember the last time I worked with a customer hitting this.“ （this 指更改语义造成的代码 break）</p><h1 id="more">more</h1><p>本文摘选以及翻译/总结自 Golang 官方仓库 Discussion 中对于该话题的帖子 <a href="https://github.com/golang/go/discussions/56010">https://github.com/golang/go/discussions/56010</a> 。完整的讨论请前往原链接。（原讨论帖 17 天内收到了 241条回复，由于社区反馈已经比较充足，新回复基本上也是旧回复的重复，原讨论帖已被 lock）</p><p>以下是原讨论帖的大致内容：</p><ul><li>原 discussion 下方的评论几乎一致地支持这个新语义变更的发生。即使是多年的 Golang 语言使用者也承认会被这个语义坑到。一致同意 per-loop 的循环变量语义是 Golang 的一个 foot gun，是问题和 bug 的一个持续来源。<li>主要的讨论点在于CI/工具链和现有代码/依赖如何平滑迁移到新的语义上，以及是否有依赖旧语义才能正确工作的合法代码会被break（不多。只找到了极其稀有的 case 是依赖 per-loop 循环变量的旧行为的，而且这个 case 本身代码就不是特别清晰）。<li>另外一个问题就是 go generate 必须生成新旧版本都能正确编译的代码，不过同样的，依赖旧语义的代码极其稀有，大多数代码生成器不会被 break。<li>一部分用户对把三段式 for loop （<code class="language-plaintext highlighter-rouge">for i := 1; i &lt; n; i++</code>）中的循环变量也修改成 per iteration 这个提议提出了质疑，主要理由是会和其他语言（主要是C以及一众类C语言）的行为不一致，其他语言背景的用户迁移过来也会被坑到。（C# 迁移到 per-iteration 循环变量作用域的时候就只迁移了 foreach，而没更改三段式 for loop 的循环变量作用域）<li>一些 practical 的问题：如何在用户升级的时候告知用户这一变动？如何检测升级前后是否会 break 用户的具体代码？这个变更应该是在 minor 版本发布还是在 major 版本（Go2）中发布？</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/language/'>Language</a>, <a href='/categories/golang/'>Golang</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/discussion/" class="post-tag no-text-decoration" >discussion</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E9%9A%8F%E7%AC%94%EF%BC%9AGolang+%E5%BE%AA%E7%8E%AF%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%AE%98%E6%96%B9%E8%AF%AD%E4%B9%89%E4%BF%AE%E5%A4%8D+-+Miigon%27s+blog&url=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fgolang-loop-var-reference-problems-and-semantic-fix%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E9%9A%8F%E7%AC%94%EF%BC%9AGolang+%E5%BE%AA%E7%8E%AF%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%AE%98%E6%96%B9%E8%AF%AD%E4%B9%89%E4%BF%AE%E5%A4%8D+-+Miigon%27s+blog&u=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fgolang-loop-var-reference-problems-and-semantic-fix%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.miigon.net%2Fposts%2Fgolang-loop-var-reference-problems-and-semantic-fix%2F&text=%E9%9A%8F%E7%AC%94%EF%BC%9AGolang+%E5%BE%AA%E7%8E%AF%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%AE%98%E6%96%B9%E8%AF%AD%E4%B9%89%E4%BF%AE%E5%A4%8D+-+Miigon%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/storing-hash-objects-on-filesystem/">[随笔]文件系统上存储哈希对象：哈希算法以及目录结构对性能的影响</a><li><a href="/posts/origin-of-git-feat-bitkeeper/">git的前世，和BitKeeper</a><li><a href="/posts/golang-loop-var-reference-problems-and-semantic-fix/">随笔：Golang 循环变量引用问题以及官方语义修复</a><li><a href="/posts/s081-lab6-copy-on-write-fork/">[mit6.s081] 笔记 Lab6: Copy-on-write fork | fork 懒拷贝</a><li><a href="/posts/mysql-prepare-slower-query-bug-analyze/">MySQL Prepare后语句查询性能降低 内核源码bug排查分析</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-system/">operating system</a> <a class="post-tag" href="/tags/chinese/">Chinese</a> <a class="post-tag" href="/tags/system-design/">system design</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/course-recommendation/">course recommendation</a> <a class="post-tag" href="/tags/grpc/">gRPC</a> <a class="post-tag" href="/tags/translated/">translated</a> <a class="post-tag" href="/tags/announcement/">announcement</a> <a class="post-tag" href="/tags/c-standard/">c++ standard</a> <a class="post-tag" href="/tags/computer-system/">computer system</a></div></div><div id="access-links" class="post"><div class="panel-heading">Links</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="http://0xffff.one">0xffff.one 搬砖技术社区</a><li><a href="https://blog.izgq.net">ZGQ's Blog</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cpp-core-language-issue-for-enum-const-redefinition/"><div class="card-body"> <em class="small" data-ts="1648908600" data-df="ll" > Apr 2, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>记一次 C++ 核心语言标准中一个 issue 的发现和提交经历</h3><div class="text-muted small"><p> 该文章记录自己的一次发现一个 C++ 核心语言标准规定中，关于枚举量重定义的一个规则缺陷（defect）并提交的经历。所有对标准的引用以 N4901 草案为准（当时的较新版本）。 C++ 核心语言标准 N4901 草案 引言 问题本身是关于 enum 中枚举值 (enumerator) 的重复定义问题的。 例子如下： enum { ee, ee }; 上面的代码，无论...</p></div></div></a></div><div class="card"> <a href="/posts/golang-project-tic-tac-toe/"><div class="card-body"> <em class="small" data-ts="1611883416" data-df="ll" > Jan 29, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Golang Project: Tic Tac Toe</h3><div class="text-muted small"><p> In this article, I’ll go through my process of writing a simple Tic-Tac-Toe game in Golang. Error handling, closures, iota as well as other golang features are used to create the game. Before...</p></div></div></a></div><div class="card"> <a href="/posts/storing-hash-objects-on-filesystem/"><div class="card-body"> <em class="small" data-ts="1672391760" data-df="ll" > Dec 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[随笔]文件系统上存储哈希对象：哈希算法以及目录结构对性能的影响</h3><div class="text-muted small"><p> 从文件系统的实现原理角度讨论 /77/e1/77e1cccccc... 模式的 hash object 命名的优点以及必要/不必要性，以及算法选择。 原贴 这是我在 0xffff 论坛的回帖的备档：https://0xffff.one/d/1395-wen-jian-xi-tong-zuo-wei-huan-cun 一个常见的业务场景，需要实现一个 Key-Value Cach...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/storing-hash-objects-on-filesystem/" class="btn btn-outline-primary" prompt="Older"><p>[随笔]文件系统上存储哈希对象：哈希算法以及目录结构对性能的影响</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "Miigon/blog", "data-repo-id": "MDEwOlJlcG9zaXRvcnkzMjI1MjkwNzA=", "data-category": "BlogComments", "data-category-id": "DIC_kwDOEzlnLs4CQ6Y4", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").prepend(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/Miigon">Miigon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Customized Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-system/">operating system</a> <a class="post-tag" href="/tags/chinese/">Chinese</a> <a class="post-tag" href="/tags/system-design/">system design</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/course-recommendation/">course recommendation</a> <a class="post-tag" href="/tags/grpc/">gRPC</a> <a class="post-tag" href="/tags/translated/">translated</a> <a class="post-tag" href="/tags/announcement/">announcement</a> <a class="post-tag" href="/tags/c-standard/">c++ standard</a> <a class="post-tag" href="/tags/computer-system/">computer system</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
