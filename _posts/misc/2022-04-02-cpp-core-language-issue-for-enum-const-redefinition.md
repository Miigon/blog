---
title: "è®°ä¸€æ¬¡ C++ æ ¸å¿ƒè¯­è¨€æ ‡å‡†ä¸­ä¸€ä¸ª issue çš„å‘ç°å’Œæäº¤ç»å†"
date: 2022-04-02 22:10:00 +0800
categories: [Language, C++]
tags: [c++ standard]
---

> è¯¥æ–‡ç« è®°å½•è‡ªå·±çš„ä¸€æ¬¡å‘ç°ä¸€ä¸ª C++ æ ¸å¿ƒè¯­è¨€æ ‡å‡†è§„å®šä¸­ï¼Œå…³äºæšä¸¾é‡é‡å®šä¹‰çš„ä¸€ä¸ªè§„åˆ™ç¼ºé™·ï¼ˆdefectï¼‰å¹¶æäº¤çš„ç»å†ã€‚æ‰€æœ‰å¯¹æ ‡å‡†çš„å¼•ç”¨ä»¥ N4901 è‰æ¡ˆä¸ºå‡†ï¼ˆå½“æ—¶çš„è¾ƒæ–°ç‰ˆæœ¬ï¼‰ã€‚

[C++ æ ¸å¿ƒè¯­è¨€æ ‡å‡† N4901 è‰æ¡ˆ](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4901.pdf)

# å¼•è¨€

é—®é¢˜æœ¬èº«æ˜¯å…³äº enum ä¸­æšä¸¾å€¼ (enumerator) çš„é‡å¤å®šä¹‰é—®é¢˜çš„ã€‚

ä¾‹å­å¦‚ä¸‹ï¼š

```c++
enum {
	ee, ee
};
```

ä¸Šé¢çš„ä»£ç ï¼Œæ— è®ºæ˜¯åœ¨ gcc/clang è¿˜æ˜¯ g++/clang++ ä¸Šï¼Œç¼–è¯‘éƒ½æ˜¯ä¸èƒ½é€šè¿‡çš„ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š
```
enumtest.cpp:3:2: error: redefinition of enumerator 'A'
        A,
        ^
enumtest.cpp:2:2: note: previous definition is here
        A,
        ^
1 error generated.
```

ä¹Ÿå°±æ˜¯å¸¸ç”¨çš„ä¸¤ä¸ªç¼–è¯‘å™¨å®ç°ä¸Šï¼Œæ— è®º C è¿˜æ˜¯ C++ éƒ½ä¸å…è®¸æšä¸¾å€¼çš„é‡å¤å®šä¹‰ï¼ˆæ³¨æ„åŒºåˆ†æšä¸¾ç±»å‹å’Œæšä¸¾å€¼ï¼‰ã€‚

C99 è‰æ¡ˆä¸­å¯¹è¯¥è¡Œä¸ºä½œå‡ºäº†æ˜ç¡®è§„å®šï¼š
> From the draft of C99, Section 6.7:  
> 6.7.5.  A declaration specifies the interpretation and attributes of a set of identifiers. A definition of an identifier is a declaration for that identifier that:  
> â€” for an object, causes storage to be reserved for that object;  
> â€” for a function, includes the function body;   
> â€” for an **enumeration constant or typedef name, is the (only) declaration of the identifier.**  

enumeration constant å³æšä¸¾å¸¸é‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°ä»£ç ä¸­çš„ `ee`ã€‚C è¯­è¨€æ ‡å‡†çš„è¿™ä¸€è§„å®šï¼Œå°±é¿å…äº†åŒä¸€ä¸ªæ ‡è¯†ç¬¦è¢«å¤šæ¬¡ç”¨äºå®šä¹‰æšä¸¾å€¼ã€‚åœ¨å®é™…çš„ä½¿ç”¨ä¸­è¿™ä¸€è¡Œä¸ºä¹Ÿç¬¦åˆé€»è¾‘ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæšä¸¾å€¼åœ¨æœªæŒ‡å®šå…·ä½“å¸¸æ•°å€¼çš„æƒ…å†µä¸‹ï¼Œæ˜¯é€’å¢åˆ†é…æ•´å½¢å¸¸æ•°å€¼çš„ï¼Œå¦‚æœå…è®¸æšä¸¾å€¼ enumerator åŒåå¯èƒ½å¯¼è‡´ä¸€ä¸ªæšä¸¾å€¼åå­—å¯¹åº”å¤šä¸ªå¸¸æ•°å€¼ï¼Œé€ æˆæ­§ä¹‰ã€‚

# é—®é¢˜

æŒ‰ç†æ¥è¯´ï¼ŒC++ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ C çš„è¶…é›†ï¼ŒC æ ‡å‡†æ˜ç¡®è§„å®šä¸èƒ½é€šè¿‡ç¼–è¯‘çš„ä»£ç ï¼Œåœ¨ C++ ä¸­åº”è¯¥ä¹Ÿä¸èƒ½é€šè¿‡ã€‚ç”±äºæšä¸¾ç±»å‹å®šä¹‰çš„æ—¶å€™ï¼Œä¼šé¡ºå¸¦å®šä¹‰å…¶ä¸­çš„æ‰€æœ‰æšä¸¾å€¼ï¼Œåˆå› ä¸ºå®šä¹‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å£°æ˜ï¼Œé‚£ä¹ˆ C++ æ ‡å‡†ä¸­å°±å¿…ç„¶å­˜åœ¨ä¸€å®šçš„è§„åˆ™ï¼Œè¦ä¹ˆé˜»æ­¢æšä¸¾é‡çš„é‡å¤å®šä¹‰ï¼Œè¦ä¹ˆé˜»æ­¢æšä¸¾é‡çš„é‡å¤å£°æ˜ï¼Œä½¿å¾—ä¸Šè¿°ä»£ç éæ³•ã€‚

## One-definition rule ä¸é˜»æ­¢æšä¸¾é‡çš„é‡å¤å®šä¹‰

å‡ºäºå¥½å¥‡ï¼ŒæŸ¥æ‰¾äº†ä¸€ä¸‹ C++ å…³äºè¿™æ–¹é¢çš„è§„å®šï¼Œäº†è§£åˆ° C++ ä¸­ï¼Œæœ‰ä¸€ä¸ªå•ç‹¬åˆ—å‡ºçš„ One-definition rule æ¡ç›®ï¼ˆ6.3 [basic.def.odr]ï¼‰ï¼Œå…¶ä¸­ç¬¬ä¸€æ¡è§„å®šå¦‚ä¸‹ï¼š

> No translation unit shall contain more than one definition of any variable, function, class type, enumeration type, template, default argument for a parameter (for a function in a given scope), or default template argument.

å³ï¼šæ‰€æœ‰çš„ç¿»è¯‘å•å…ƒéƒ½ä¸å¯ä»¥åŒ…å«å¤šäºä¸€ä¸ªçš„ä»»ä½•å˜é‡ã€å‡½æ•°ã€ç±»ã€**æšä¸¾ç±»å‹**ã€æ¨¡ç‰ˆã€å‚æ•°é»˜è®¤å€¼æˆ–é»˜è®¤æ¨¡ç‰ˆå‚æ•°çš„å®šä¹‰ã€‚

è¿™é‡Œç‰¹åˆ«æ³¨æ„åˆ°ï¼Œ**One-definition rule é™åˆ¶äº†ã€Œæšä¸¾ç±»å‹ã€çš„é‡å¤å®šä¹‰ï¼Œä½†æ˜¯æ²¡æœ‰é™åˆ¶ã€Œæšä¸¾é‡ã€çš„é‡å¤å®šä¹‰ã€‚**

å½“ç„¶ One-definition rule ç›¸å½“äºæ˜¯åœ¨åŸæ¥çš„å£°æ˜/å®šä¹‰è§„åˆ™ä¸Šæ‰“çš„ä¸€ä¸ªâ€œè¡¥ä¸â€ï¼Œç›´æ¥ç”¨ç‰¹æ®Šè§„åˆ™æ¥é™åˆ¶ä¸€äº›ç§ç±»å®ä½“çš„é‡å¤å®šä¹‰ã€‚å¹¶ä¸ä»£è¡¨æ ‡å‡†ä¸­çš„å…¶ä»–è§„åˆ™å°±ä¸ä¼šé™åˆ¶é‡å¤å®šä¹‰çš„æšä¸¾å€¼çš„å­˜åœ¨ï¼ˆè¿™åœ¨åç»­ä¸å§”å‘˜ä¼šçš„é‚®ä»¶äº¤æµä¸­ä¹Ÿæ¶‰åŠåˆ°äº†ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰é™åˆ¶å¹¶ä¸è¶³ä»¥ä½œä¸ºå…è®¸æšä¸¾é‡é‡å¤å®šä¹‰çš„å……åˆ†æ¡ä»¶ã€‚

ç”±äºå®šä¹‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å£°æ˜ï¼Œè™½ç„¶å®šä¹‰ definition ç›¸å…³çš„è§„åˆ™æ²¡èƒ½é˜»æ­¢ä¾‹å­ä¸­çš„ä»£ç é€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¯èƒ½åœ¨å£°æ˜ declaration ä¸­é˜»æ­¢äº†è¿™æ ·é‡å¤å£°æ˜æšä¸¾é‡çš„æƒ…å†µå‡ºç°ï¼Œæ•…ç»§ç»­æ¢å¯»ï¼Œå‘ç°ï¼š

## declaration å£°æ˜è§„åˆ™å…è®¸æšä¸¾é‡é‡å¤å£°æ˜

### ä¸¤æ¬¡ `ee` å£°æ˜çš„æ˜¯åŒä¸€å®ä½“
ç»§ç»­æµè§ˆæ ‡å‡†ä¸­å…³äºå£°æ˜ declaration å’Œå®šä¹‰ definition çš„ç« èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æè¿°ï¼š

6.6 [basic.link] paragraph 8:
> **Two declarations** of entities **declare the same entity if**, considering declarations of unnamed types to introduce their names for linkage purposes, if any (9.2.4, 9.7.1), they **correspond** (6.4.1), **have the same target scope** that is not a function or template parameter scope, and either
> - they **appear in the same translation unit**, or....... ï¼ˆåç»­å‡ ç§æƒ…å†µä¸é—®é¢˜æ— å…³ï¼Œæ•…æ²¡æœ‰åˆ—å‡ºï¼‰

å³ä¸¤ä¸ªå®ä½“å£°æ˜ï¼ˆåœ¨è¿™é‡ŒæŒ‡ä¸¤æ¬¡æšä¸¾é‡å®šä¹‰ `ee` å’Œ `ee`ï¼Œå®šä¹‰ä¹Ÿæ˜¯ä¸€ç§å£°æ˜ï¼‰å¦‚æœå®ƒä»¬æ»¡è¶³ï¼š
* ç›¸äº’ã€Œå¯¹åº”ã€ï¼ˆä¾‹å­æ»¡è¶³ï¼‰
* åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸï¼ˆä¾‹å­æ»¡è¶³ï¼‰
* ä¸”å‡ºç°åœ¨åŒä¸€ä¸ªç¿»è¯‘å•å…ƒï¼ˆä¾‹å­æ»¡è¶³ï¼‰

åˆ™ä»–ä»¬å£°æ˜çš„æ˜¯åŒä¸€ä¸ªå®ä½“ã€‚

ã€Œå¯¹åº” correspondã€çš„æ„æ€ï¼Œåœ¨6.4.1 [basic.scope.scope], paragraph 4 ä¸­æŒ‡å‡ºï¼š
> **Two declarations correspond if they (re)introduce the same name**, both declare constructors, or both declare destructors, unless......  
> ï¼ˆåé¢çš„æ’é™¤æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œä½†éƒ½ä¸é€‚ç”¨æœ¬æ–‡ä¸­çš„ä¾‹å­ï¼Œæ•…çœç•¥ï¼‰

åœ¨è¿™é‡Œï¼Œä¸¤ä¸ªæšä¸¾é‡å£°æ˜ç”±äºå¼•å…¥äº†åŒä¸€ä¸ªåå­—ï¼Œæ‰€ä»¥è¯´å®ƒä»¬ã€Œå¯¹åº”ã€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬æ»¡è¶³äº†å£°æ˜åŒä¸€ä¸ªå®ä½“çš„ä¸‰ä¸ªæ¡ä»¶ï¼Œ**ä¸¤æ¬¡ `ee` å£°æ˜çš„æ˜¯åŒä¸€å®ä½“**ã€‚

> è¿™ä¸ªè§„åˆ™ä¸€èˆ¬æ˜¯æœåŠ¡äºå‡½æ•°å£°æ˜ã€å˜é‡å£°æ˜æˆ–è€…ç±»å‹å£°æ˜çš„ï¼Œå³å¤šæ¬¡å£°æ˜åŒä¸€ä¸ªå‡½æ•°ï¼Œå£°æ˜çš„å…¶å®éƒ½æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼š
> ```c++
> // ä¾‹å­ï¼šæ­¤ä»£ç æ˜¯åˆæ³•C++ç¨‹åºï¼Œèƒ½é€šè¿‡ç¼–è¯‘
> void foobar();// å£°æ˜
> void foobar();// å†æ¬¡å£°æ˜
> void foobar() {} // å†æ¬¡å£°æ˜ï¼Œå¹¶å®šä¹‰ï¼Œå‰é¢æ‰€æœ‰çš„å£°æ˜éƒ½æŒ‡å‘è¿™é‡Œå®šä¹‰çš„å®ä½“
> int main() {
> 	foobar();
> }
> ```
> ä½†æ˜¯åœ¨è¿™ä¸€å¥—è§„åˆ™ä¸‹ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹ä¾‹å­ä¸­çš„æšä¸¾é‡å®šä¹‰ `ee` å’Œ `ee` ä¹Ÿæ°å¥½ç¬¦åˆè¿™é‡Œçš„è¦æ±‚ï¼Œå³ä¸¤æ¬¡æŒ‡å‘åŒä¸€ä¸ªå®ä½“ã€‚

ä¸¤æ¬¡ `ee` å£°æ˜çš„æ˜¯åŒä¸€å®ä½“ä¸ºä»€ä¹ˆé‡è¦å‘¢ï¼Ÿå› ä¸ºå£°æ˜è¿˜æœ‰ä¸€ç§ã€Œå†²çªã€çš„æƒ…å†µå¦‚ä¸‹ï¼š

### ä¸¤æ¬¡ `ee` å£°æ˜ä¸æ»¡è¶³ã€Œå¯èƒ½å†²çªã€çš„æ¡ä»¶ï¼Œä¸é€ æˆå†²çª

6.4.1 [basic.scope.scope]:
> **Two declarations _potentially conflict_ if they correspond and cause their shared name to denote different entities (6.6)**. The program is ill-formed if, in any scope, a name is bound to two declarations that _potentially conflict_ and one precedes the other (6.5).

å½“ä¸¤ä¸ªå£°æ˜ã€Œå¯¹åº”ã€ï¼ˆæ»¡è¶³ï¼‰å¹¶ä½¿å¾—ä»–ä»¬å…±æœ‰çš„åå­—**æŒ‡å‘ä¸¤ä¸ªä¸åŒå®ä½“æ—¶**ï¼Œä¸¤ä¸ªå£°æ˜å³ã€Œå¯èƒ½å†²çªã€ã€‚

è€Œå‰é¢ä¸€æ®µå·²ç»è¯´æ˜äº†ï¼Œä¸¤æ¬¡ `ee` å£°æ˜ï¼ŒæŒ‡å‘çš„æ˜¯**åŒä¸€å®ä½“**ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œã€Œå¯èƒ½å†²çªã€çš„è§„åˆ™å¹¶ä¸é€‚ç”¨ï¼Œä¸¤æ¬¡å£°æ˜ä¸å†²çªã€‚

## ç»“è®ºï¼šæšä¸¾é‡é‡å¤å®šä¹‰ä¸è¿å C++ æ ‡å‡†ï¼

ç”±äº One-definition rule å¹¶ä¸é™åˆ¶æšä¸¾é‡çš„é‡å¤å®šä¹‰ï¼Œè€Œä¸¤æ¬¡æšä¸¾é‡å£°æ˜æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå®ä½“ï¼Œä¸ä¼šé€ æˆå£°æ˜å†²çªï¼Œæ„å‘³ç€ä¸€å¼€å§‹çš„ç¤ºä¾‹ä»£ç ï¼š

```c++
enum {
	ee, ee
};
```

å…¶ä¸­é‡å¤çš„ `ee`ï¼Œæ— è®ºæ˜¯ä»å®ä½“å®šä¹‰çš„è§’åº¦ï¼Œè¿˜æ˜¯ä»å®ä½“å£°æ˜çš„è§’åº¦ï¼Œéƒ½**ä¸è¿å C++ æ ‡å‡†ä¸­çš„è§„åˆ™**ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰ C++ æ ‡å‡†æ²¡æœ‰åƒ C æ ‡å‡†ä¸€æ ·æˆåŠŸé˜»æ­¢è¯¥æœ‰æ­§ä¹‰çš„ç¨‹åºé€šè¿‡ç¼–è¯‘ã€‚

# æ€»ç»“

å½“ç„¶ï¼Œå¯¹åŒä¸€ä¸ªåå­—è¿›è¡Œå¤šæ¬¡æšä¸¾é‡å®šä¹‰è‚¯å®šåœ¨é€»è¾‘ä¸Šæ˜¯é”™è¯¯çš„ï¼Œæ¯ä¸ªæšä¸¾é‡éƒ½å¿…é¡»å¯¹åº”ã€Œä¸€ä¸ªã€æ•´å‹å¸¸é‡ï¼Œæ¯ä¸€ä¸ªæšä¸¾é‡å®šä¹‰åˆä¼šä½¿å¾—æšä¸¾é‡å¯¹åº”çš„å¸¸é‡ç›¸æ¯”ä¸Šä¸€ä¸ªæšä¸¾é‡å®šä¹‰å¢1ï¼Œå…è®¸åŒä¸ªåå­—å®šä¹‰ä¸¤æ¬¡æšä¸¾é‡çš„è¯ï¼Œè¿™ä¸¤ä¸ªè§„åˆ™å°±äº§ç”ŸçŸ›ç›¾äº†ã€‚ï¼ˆä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œee åŒæ—¶å¯¹åº” 0 å’Œ 1ï¼‰

åœ¨è¿™é‡Œï¼Œåˆç†çš„è§£å†³æ–¹æ³•åº”è¯¥æ˜¯å°†æšä¸¾å€¼ (enumeratorã€enumeration constant) åŠ å…¥åˆ° One-definition rule ä¸­ï¼Œé˜»æ­¢æšä¸¾å€¼çš„é‡å¤å®šä¹‰ã€‚

æˆ‘ä¹Ÿå°†ç›¸å…³çš„ä¿¡æ¯æäº¤ç»™äº† C++ æ ‡å‡†å§”å‘˜ä¼šç›¸å…³äººå‘˜ï¼Œå¹¶ç»è¿‡å‡ è½®é‚®ä»¶æ¥å›è§£é‡Šï¼Œè¯¥é—®é¢˜å·²ç»è¢«æ¥å—å¹¶æˆä¸º [C++ æ ¸å¿ƒè¯­è¨€è®®é¢˜ #2530](http://www.open-std.org/jtc1/sc22/wg21/docs/cwg_active.html#2530)ã€‚åº”è¯¥ä¼šåœ¨ä¸‹ä¸€æ¬¡å§”å‘˜ä¼šä¼šè®®ä¸­è®¨è®ºå¹¶å¯èƒ½åœ¨æœªæ¥è‰æ¡ˆä¸­ä¿®å¤ã€‚
```
That's a good point that I had overlooked; it seemed clear that 
two enumerators (that, in general, have different values) cannot 
declare the same entity, which in the case of an enumerator, is 
only a value. However, this wording contradicts that reasoning, 
so you've convinced me. This will be issue 2530 in revision 108 
of the core language issues list.
                                      -- William M. (Mike) Miller
```

æœ€å¥‡å¦™çš„æ˜¯ï¼Œè¿™ä¸ªç–å¿½è™½ç„¶çœ‹èµ·æ¥å¾ˆå¾®ä¸è¶³é“ï¼Œä½†å®ƒè‡³å°‘ä» [C++03](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2005/n1905.pdf) ä¹‹å‰å°±å­˜åœ¨äº†ï¼ˆC++03 æ ‡å‡†æ–‡æ¡£æœ‰ç‰ˆæƒé—®é¢˜ï¼Œè¿™é‡Œé“¾æ¥æ˜¯2005å¹´çš„å·¥ä½œç¨¿ï¼‰ï¼Œä¸€ç›´å­˜åœ¨äº†20æ¥å¹´ï¼ŒæœŸé—´çš„ç¼–è¯‘å™¨ä½œè€…ä¹Ÿéƒ½é»˜è®¤æŒ‰ç…§ C çš„è§„åˆ™å»å¤„ç†äº†ï¼Œä¹Ÿæ²¡æœ‰äººæäº¤è¿‡ç›¸å…³ defectã€‚ç”šè‡³æœ‰ç†ç”±æ€€ç–‘æ˜¯ C++ æ ‡å‡†é‡Œå­˜åœ¨æ—¶é—´æœ€ä¹…çš„ bug ä¹‹ä¸€ï¼Œæœç„¶æœ€ç®€å•çš„é—®é¢˜è—åœ¨çœ¼çš®åº•ä¸‹åè€Œä¸å®¹æ˜“è¢«å‘ç° ğŸ˜ƒ ã€‚

> æˆ‘çš„åšå®¢å³å°†åŒæ­¥è‡³è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼Œé‚€è¯·å¤§å®¶ä¸€åŒå…¥é©»ï¼šhttps://cloud.tencent.com/developer/support-plan?invite_code=h98n0pl8nhui